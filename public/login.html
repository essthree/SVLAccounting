<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Login - Accounting System</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .login-container {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
  
  h1 {
    color: #333;
    margin-bottom: 30px;
    font-size: 28px;
  }
  
  .login-description {
    color: #666;
    margin-bottom: 30px;
    line-height: 1.5;
  }
  
  .google-signin-btn {
    background: #4285f4;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    transition: background-color 0.2s;
  }
  
  .google-signin-btn:hover {
    background: #3367d6;
  }
  
  .google-signin-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .loading {
    display: none;
    color: #666;
    margin-top: 20px;
  }
  
  .error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    padding: 12px;
    border-radius: 6px;
    margin-top: 20px;
    display: none;
  }
</style>
<script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
  <div class="login-container">
    <h1>Accounting System</h1>
    <p class="login-description">
      Please sign in with your Google account to access the accounting system.
    </p>
    
    <button id="googleSignIn" class="google-signin-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
      </svg>
      Sign in with Google
    </button>
    
    <div id="loading" class="loading">Signing you in...</div>
    <div id="error" class="error"></div>
    
    <!-- Persistent debug area -->
    <div id="debugArea" style="position: fixed; bottom: 10px; left: 10px; right: 10px; background: #f0f0f0; border: 2px solid #333; padding: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; z-index: 10000; display: none;">
      <div style="font-weight: bold; margin-bottom: 5px;">Debug Log:</div>
      <div id="debugContent"></div>
      <button onclick="document.getElementById('debugArea').style.display='none'" style="position: absolute; top: 5px; right: 5px;">Ã—</button>
    </div>
  </div>

  <script>
    let GOOGLE_CLIENT_ID = null;
    
    // Debug logging function
    function addDebugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const debugArea = document.getElementById('debugArea');
      const debugContent = document.getElementById('debugContent');
      
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '5px';
      logEntry.style.borderBottom = '1px solid #ccc';
      logEntry.style.paddingBottom = '3px';
      
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
      if (data) {
        logEntry.innerHTML += `<br><pre style="margin: 2px 0; font-size: 10px;">${JSON.stringify(data, null, 2)}</pre>`;
      }
      
      debugContent.appendChild(logEntry);
      debugArea.style.display = 'block';
      debugContent.scrollTop = debugContent.scrollHeight;
      
      console.log(`[${timestamp}] ${message}`, data);
    }
    
    // Global error handler to catch all errors
    window.addEventListener('error', (event) => {
      const errorMsg = `Global error: ${event.error?.message || event.message}`;
      addDebugLog('GLOBAL ERROR', { error: errorMsg, stack: event.error?.stack });
      localStorage.setItem('lastGlobalError', JSON.stringify({
        timestamp: new Date().toISOString(),
        error: errorMsg,
        stack: event.error?.stack
      }));
    });
    
    // Unhandled promise rejection handler
    window.addEventListener('unhandledrejection', (event) => {
      const errorMsg = `Unhandled promise rejection: ${event.reason}`;
      addDebugLog('PROMISE REJECTION', { error: errorMsg });
      localStorage.setItem('lastPromiseError', JSON.stringify({
        timestamp: new Date().toISOString(),
        error: errorMsg
      }));
    });
    
    // Initialize Google Sign-In
    window.addEventListener('load', () => {
      // Show any previous errors for debugging
      const lastError = localStorage.getItem('lastLoginError');
      const lastGlobalError = localStorage.getItem('lastGlobalError');
      const lastPromiseError = localStorage.getItem('lastPromiseError');
      
      if (lastError) {
        const errorData = JSON.parse(lastError);
        console.log('Previous login error:', errorData);
      }
      if (lastGlobalError) {
        const errorData = JSON.parse(lastGlobalError);
        console.log('Previous global error:', errorData);
      }
      if (lastPromiseError) {
        const errorData = JSON.parse(lastPromiseError);
        console.log('Previous promise error:', errorData);
      }
      
      // Add debug button to view all stored errors
      const debugBtn = document.createElement('button');
      debugBtn.textContent = 'Show Debug Info';
      debugBtn.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;padding:5px;';
      debugBtn.onclick = () => {
        const allErrors = {
          loginError: lastError ? JSON.parse(lastError) : null,
          globalError: lastGlobalError ? JSON.parse(lastGlobalError) : null,
          promiseError: lastPromiseError ? JSON.parse(lastPromiseError) : null
        };
        console.log('=== ALL DEBUG INFO ===', allErrors);
        alert('Debug info logged to console. Check F12 > Console tab.');
      };
      document.body.appendChild(debugBtn);
      
      loadGoogleConfig();
    });
    
    async function loadGoogleConfig() {
      try {
        console.log('=== CONFIG DEBUG START ===');
        console.log('Fetching config from:', '/api/config');
        
        const response = await fetch('/api/config');
        console.log('Config response status:', response.status);
        console.log('Config response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`Config fetch failed: ${response.status} ${response.statusText}`);
        }
        
        const config = await response.json();
        console.log('Config received:', config);
        
        GOOGLE_CLIENT_ID = config.googleClientId;
        console.log('Google Client ID set:', GOOGLE_CLIENT_ID);
        
        if (!GOOGLE_CLIENT_ID) {
          throw new Error('Google Client ID not found in config');
        }
        
        // Initialize with render method instead of prompt
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse,
          auto_select: false,
          cancel_on_tap_outside: false,
          error_callback: (error) => {
            console.error('Google Sign-In initialization error:', error);
            showError(`Google Sign-In error: ${error.type || error.message || 'Unknown error'}`);
          }
        });
        
        // Create a container for the Google button
        const buttonContainer = document.createElement('div');
        buttonContainer.id = 'google-button-container';
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'center';
        buttonContainer.style.marginTop = '10px';
        
        // Insert after the custom button
        const customButton = document.getElementById('googleSignIn');
        customButton.parentNode.insertBefore(buttonContainer, customButton.nextSibling);
        
        // Render the Google button in the container
        try {
          google.accounts.id.renderButton(
            buttonContainer,
            { 
              theme: 'outline', 
              size: 'large',
              width: 250,
              text: 'signin_with'
            }
          );
        } catch (renderError) {
          console.error('Google button render error:', renderError);
          showError(`Button render failed: ${renderError.message}`);
        }
        
        // Hide our custom button
        customButton.style.display = 'none';
        
        console.log('=== CONFIG DEBUG END ===');
        
      } catch (error) {
        console.error('=== CONFIG ERROR ===');
        console.error('Config load error:', error);
        console.error('Error stack:', error.stack);
        showError('Failed to load Google configuration: ' + error.message);
      }
    }
    
    function handleCredentialResponse(response) {
      addDebugLog('LOGIN ATTEMPT STARTED');
      addDebugLog('Google credential response', response);
      showLoading(true);
      
      // Send the ID token to your server
      fetch('/auth/google', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
          token: response.credential
        })
      })
      .then(res => {
        addDebugLog('Server response received', { status: res.status, ok: res.ok });
        return res.json();
      })
      .then(data => {
        addDebugLog('Server response data', data);
        if (data.success) {
          addDebugLog('Login successful - redirecting to main app');
          showError('Login successful! Redirecting...');
          // Redirect to main app
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        } else {
          addDebugLog('Login failed', { error: data.error });
          showError(data.error || 'Login failed');
        }
      })
      .catch(error => {
        addDebugLog('Network error during login', { 
          message: error.message, 
          stack: error.stack 
        });
        showError('Network error during login: ' + error.message);
      })
      .finally(() => {
        showLoading(false);
        addDebugLog('LOGIN ATTEMPT FINISHED');
      });
    }
    
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
    
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      // Also log to console with timestamp for persistence
      const timestamp = new Date().toISOString();
      console.error(`[${timestamp}] LOGIN ERROR:`, message);
      
      // Store error in localStorage for debugging
      localStorage.setItem('lastLoginError', JSON.stringify({
        timestamp,
        error: message
      }));
    }
    
    // Clear any existing session first
    fetch('/auth/logout', { 
      method: 'POST',
      credentials: 'include' 
    }).finally(() => {
      // Check if already logged in
      fetch('/auth/status', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.authenticated) {
            window.location.href = '/';
          }
        })
        .catch(() => {
          // Not logged in, stay on login page
        });
    });
  </script>
</body>
</html>
